version: 2.1

orbs:
  maven: circleci/maven@1.4.1
  codecov: codecov/codecov@4.0.1

jobs:
  build:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Build
          command: mvn compile

  test:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Run Tests
          command: mvn test

  upload-to-codecov:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: "Tests with JaCoCo coverage"
          command: mvn clean verify jacoco:report
      - codecov/upload

  generate-javadoc:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Generate Javadoc
          command: mvn javadoc:javadoc

  deploy-to-gh-pages:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Deploy Javadoc to GitHub Pages
          command: |
            git config --global user.email "isfurtado@hotmail.com"
            git config --global user.name "ingridsimoes"
            git clone https://github.com/ingridsimoes/ceri-m1-techniques-de-test.git repo
            cd repo
            if git show-ref --verify --quiet refs/heads/gh-pages; then
               git checkout gh-pages
            else
               git checkout --orphan gh-pages
            fi
            git rm -rf .
            cp -r ../target/site/apidocs/* .
            git add .
            git commit -m "Deploy Javadoc to GitHub Pages" || echo "No changes to commit"
            git push origin gh-pages


workflows:
  version: 2.1
  build_and_test:
    jobs:
      - build
      - test
      - upload-to-codecov:
          requires:
            - test
      - generate-javadoc:
          requires:
            - test
      - deploy-to-gh-pages:
          requires:
            - generate-javadoc
          filters:
            branches:
              only:
                - main
